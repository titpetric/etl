---
version: "3"

env:
  CGO_ENABLED: 0

tasks:
  default:
    desc: "Set up a server DB, run etl server"
    env:
      ETL_DB_DRIVER: sqlite
      ETL_DB_DSN: file:petstore.db
    cmds:
      - rm -f petstore.db venom.log server.log
      - etl query petstore.sql
      - cmd: (timeout 60s etl server > server.log 2>&1 &) && sleep 2 && venom run petstore-test.yml; pkill -f "etl server" || true
        ignore_error: true
      - defer: rm -f venom.log server.log

  setup:
    desc: "Install dev tooling"
    cmds:
      - curl -s https://github.com/ovh/venom/releases/download/v1.2.0/venom.linux-amd64 -L -o /usr/local/bin/venom && chmod +x /usr/local/bin/venom
